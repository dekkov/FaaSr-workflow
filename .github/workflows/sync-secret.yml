name: Sync GitHub Secrets to Cloud Secret Managers

on:
  workflow_dispatch:
    inputs:
      secret_names:
        description: 'Comma-separated list of GitHub secret names to sync (e.g., DB_PASSWORD,API_KEY)'
        required: true
        type: string
      sync_to_aws:
        description: 'Sync to AWS Secrets Manager'
        required: true
        type: boolean
        default: true
      sync_to_gcp:
        description: 'Sync to Google Secret Manager'
        required: true
        type: boolean
        default: false
      aws_region:
        description: 'AWS region for Secrets Manager (e.g., us-west-2, us-east-1)'
        required: true
        type: string
        default: 'us-east-1'
      aws_secret_prefix:
        description: 'Prefix for AWS Secrets Manager secret names (optional)'
        required: false
        type: string
      gcp_project_id:
        description: 'GCP Project ID'
        required: false
        type: string
      gcp_secret_prefix:
        description: 'Prefix for Google Secret Manager secret names (optional)'
        required: false
        type: string


jobs:
  make-matrix:
    runs-on: ubuntu-latest
    outputs:
      secret_matrix: ${{ steps.set-matrix.outputs.secret_matrix }}
    steps:
      - id: set-matrix
        run: |
          # Parse user input into a JSON array for matrix strategy
          IFS=',' read -ra secrets <<< "${{ github.event.inputs.secret_names }}"
          arr_json="["
          for secret in "${secrets[@]}"; do
            s=$(echo "$secret" | xargs) # trim whitespace
            arr_json="$arr_json\"$s\","
          done
          arr_json="${arr_json%,}" # remove trailing comma
          arr_json="$arr_json]"
          echo "secret_matrix=$arr_json" >> $GITHUB_OUTPUT

  sync_aws:
    needs: make-matrix
    runs-on: ubuntu-latest
    if: ${{ fromJSON(github.event.inputs.sync_to_aws) }}
    strategy:
      fail-fast: false
      matrix:
        secret_name: ${{ fromJson(needs.make-matrix.outputs.secret_matrix) }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ github.event.inputs.aws_region }}  

      - name: Sync secret to AWS Secrets Manager
        env:
          SECRET_VALUE: ${{ secrets[ matrix.secret_name ] }}
          AWS_SECRET_ID: ${{ github.event.inputs.aws_secret_prefix }}${{ matrix.secret_name }}
        run: |
          if [ -z "$SECRET_VALUE" ] || [ "$SECRET_VALUE" == "***" ]; then
            echo "::warning:: Secret '${{ matrix.secret_name }}' not found or not accessible. Skipping."
            exit 0
          fi
      
          echo "Syncing '${{ matrix.secret_name }}' to AWS Secrets Manager as '$AWS_SECRET_ID'..."
      
          if aws secretsmanager describe-secret --secret-id "$AWS_SECRET_ID" > /dev/null 2>&1; then
            # If secret exists, update it
            aws secretsmanager put-secret-value --secret-id "$AWS_SECRET_ID" --secret-string "$SECRET_VALUE"
          else
            # Create secret if it does not exist
            aws secretsmanager create-secret --name "$AWS_SECRET_ID" --secret-string "$SECRET_VALUE"
          fi

  sync_gcp:
    needs: make-matrix
    runs-on: ubuntu-latest
    if: ${{ fromJSON(github.event.inputs.sync_to_gcp) }}
    strategy:
      fail-fast: false
      matrix:
        secret_name: ${{ fromJson(needs.make-matrix.outputs.secret_matrix) }}
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Sync secret to Google Secret Manager
        env:
          SECRET_VALUE: ${{ secrets[ matrix.secret_name ] }}
          GCP_PROJECT_ID: ${{ github.event.inputs.gcp_project_id }}
          GCP_SECRET_ID: ${{ github.event.inputs.gcp_secret_prefix }}${{ matrix.secret_name }}
        run: |
          if [ -z "$SECRET_VALUE" ] || [ "$SECRET_VALUE" == "***" ]; then
            echo "::warning:: Secret '${{ matrix.secret_name }}' not found or not accessible. Skipping."
            exit 0
          fi

          # Set default project
          gcloud config set project "$GCP_PROJECT_ID"

          # Check if the secret exists
          if gcloud secrets describe "$GCP_SECRET_ID" --project "$GCP_PROJECT_ID" >/dev/null 2>&1; then
            echo "Adding new version to existing secret $GCP_SECRET_ID"
            printf '%s' "$SECRET_VALUE" | gcloud secrets versions add "$GCP_SECRET_ID" --data-file=-
          else
            echo "Creating new secret $GCP_SECRET_ID"
            gcloud secrets create "$GCP_SECRET_ID" --replication-policy="automatic"
            printf '%s' "$SECRET_VALUE" | gcloud secrets versions add "$GCP_SECRET_ID" --data-file=-
          fi